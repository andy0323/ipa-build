#!/usr/bin/env node

var shell   = require('shelljs');
var program = require('commander');
var version = require("../package.json").version;
var utils   = require("../lib/utils")

Array.prototype.contain = function(obj) { return this.indexOf(obj) !== -1;}

program
  .version(version)
    .usage(" ipa-build xcodeproj_path")
    .option('-v, --verbose', '打印详细日志')
    .option('-o, --output [output]', '指定ipa输出路径')
  .parse(process.argv);


// 是否打印
var _verbose = program.verbose;
utils.verbose = _verbose;

// 输出ipa路径
var output   = program.output;


// 判断参数输入
var args = program.args;
if (args.length != 1) {
    console.log('请输入搜索文件夹路径');  
};

// 搜索文件路径
var search_folder = args[0];

// 查找pbxproj文件
var pbxproj_search_result = shell.find('-R', search_folder).filter(function(file) { return file.match(/\.pbxproj$/); });

// 搜索项目引用索引
var pbxproj_main_arr = new Array;
if (pbxproj_search_result.length > 1) {

  for (var i = 0; i < pbxproj_search_result.length; i++) {
    
    var pbxproj = pbxproj_search_result[i];
    var content = shell.cat(pbxproj);

    var reg = /PBXContainerItemProxy/g;
    var search_res = reg.test(content);
    if (search_res == true) {
      pbxproj_main_arr.push(pbxproj);
    }
  };

  if (pbxproj_main_arr.length != 1) {
    console.log('工程文件搜索失败,请确认文件路径..'); return;
  }  

}else if (pbxproj_search_result.length == 1){
  pbxproj_main_arr = pbxproj_search_result;
}else {
  console.log('没有匹配的工程文件'); return;  
}

// 获取工程路径
var pbxproj_splite_arr = pbxproj_main_arr[0].split('/')
// 获取上级文件夹路径
pbxproj_splite_arr.pop();

// 获取工程主路径
var xcodeproj_path = pbxproj_splite_arr.join('/');

// 解析所有参数，设置默认参数
var arr = xcodeproj_path.split('/');

var proj_name  = arr.pop().split('.')[0];
var fold_path  = arr.join('/');
var build_path = shell.pwd() + '/ipa-build-path';
var app_path   = build_path + '/' + proj_name + '.app';
var ipa_path   = build_path + '/' + proj_name + '.ipa';

// 通过用户的输入, 重新设置配置项
if (program.output) {
  ipa_path = output;
}

utils.log('项目名称='       +    proj_name);
utils.log('文件夹路径='     +    fold_path);
utils.log('输出文件路径='    +   build_path);
utils.log('编译包路径='     +    app_path);
utils.log('安装包输出路径='  +    ipa_path);

// 运行程序
require('../index')(xcodeproj_path, ipa_path, build_path, proj_name, app_path);